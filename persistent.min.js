"use strict";function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}function _inherits(n,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);n.prototype=Object.create(e&&e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(n,e):n.__proto__=e)}function registerType(n){function e(){var t=fromCache(id)||fromModel(new(_bind.apply(n,[null].concat(_slice.call(arguments)))),id);return e.items.push(t),t}return e.load=fromCache,e.create=function(t){cache.get(t)&&destroy(exists);var r=fromModel(new(_bind.apply(n,[null].concat(_slice.call(arguments)))),t);return e.items.push(r),r},e.find=function(n){return sift(n,e.items)},e.items=new Parray(n.name),types[n.name]=n,window[n.name]!==n?console.warn("Given type, "+n.name+" isn't on the global scope. Be sure to use the return value"):window[n.name]=e,e}function fromCache(n){if(loadedItems[n])return loadedItems[n];var e=cache.get(n);if(!e)return void 0;var t=types[e.type]?new types[e.type]:{},r=e.childIDs.concat(e.disownedIDs.concat(Object.keys(e.siblingIDs)));return _.difference(Object.keys(t),r).forEach(function(n){delete t[n]}),align(t,e,"CACHE")}function fromModel(n,e){var e=e||cacheID++,t={};for(var r in n)_.isObject(n[r])&&(n[r].pInfo||(n[r]=fromModel(n[r])),t[r]=n[r].pInfo.id);var o=["id","childIDs","disownedIDs","siblingIDs"].concat(n.dontCache),i={id:e,type:n.constructor.name,disownedIDs:o,childIDs:_.difference(Object.keys(n),o.concat(Object.keys(t))),siblingIDs:t};return align(n,i,"MODEL")}function align(n,e,t){Object.defineProperty(n,"pInfo",{value:e,writeable:!1}),loadedItems[n.pInfo.id]=n;for(var r in n.pInfo.childIDs)alignChild(n,n.pInfo.childIDs[r],t);for(var r in n.pInfo.siblingIDs)alignSibling(n,r,t);return cache.set(n.pInfo.id,n.pInfo),watchForChanges(n),n}function alignChild(n,e,t){var r=n.pInfo.id+"."+e;"MODEL"===t&&cache.set(r,n[e]),n.__defineGetter__(e,function(){return cache.get(r)}),n.__defineSetter__(e,function(t){return"object"==typeof t?(delete n[e],n[e]=t):cache.set(r,t),t})}function alignSibling(n,e,t){if("MODEL"===t)var r=n[e].pInfo?n[e]:fromModel(n[e],n.pInfo.siblingIDs[e]);else{if("CACHE"!==t)throw new Error("Invalid source!");var r=fromCache(n.pInfo.siblingIDs[e])}n.__defineGetter__(e,function(){return r}),n.__defineSetter__(e,function(t){return delete n[e],delete n.pInfo.siblingIDs[e],n[e]=t,t})}function watchForChanges(n){Object.observe(n,function(e){e.forEach(function(e){_.includes(n.pInfo.disownedIDs,e.name)||("add"==e.type&&e.name in n?_.isObject(n[e.name])?(alignSibling(n,e.name,"MODEL"),n.pInfo.siblingIDs[e.name]=n[e.name].pInfo.id):(alignChild(n,e.name,"MODEL"),n.pInfo.childIDs.push(e.name)):"delete"==e.type&&(_.pull(n.pInfo.childIDs,e.name),cache.clear(n.pInfo.id+"."+e.name)),cache.set(n.pInfo.id,n.pInfo))})},["add","delete"])}function destroy(n){var e=n.childIDs;for(var t in e)_.isObject(n[e[t]])&&destroy(n[e[t]]),cache.clear(e[t]);cache.clear(n.pInfo.cid)}var _bind=Function.prototype.bind,_slice=Array.prototype.slice,_get=function(n,e,t){for(var r=!0;r;){var o=n,i=e,c=t;u=a=f=void 0,r=!1,null===o&&(o=Function.prototype);var u=Object.getOwnPropertyDescriptor(o,i);if(void 0!==u){if("value"in u)return u.value;var f=u.get;return void 0===f?void 0:f.call(c)}var a=Object.getPrototypeOf(o);if(null===a)return void 0;n=a,e=i,t=c,r=!0}};void 0===Function.prototype.name&&void 0!==Object.defineProperty&&Object.defineProperty(Function.prototype,"name",{get:function(){var n=/function\s([^(]{1,})\(/,e=n.exec(this.toString());return e&&e.length>1?e[1].trim():""},set:function(n){}});var cacheID=1,cache={set:function(n,e){arguments.length<=2||void 0===arguments[2]?!0:arguments[2];if(void 0==n||null==n)throw new Error("Key cannot be null");"string"!=typeof e&&(e=JSON.stringify(e)),localStorage.setItem(n,e)},get:function(n){if(void 0==n||null==n)throw new Error("Key cannot be null");var e=localStorage.getItem(n);return void 0===e||null===e?e:"{"===e.charAt(0)||"["===e.charAt(0)||_.isNumeric(e)||_.isBoolean(e)?JSON.parse(e):e},clear:localStorage.removeItem.bind(localStorage),clearAll:localStorage.clear.bind(localStorage),push:function(n,e,t){var r=this.get(n)||[];if(t&&_.includes(r,n))throw new Error("Cache array already has this key in it and we care.");r.push(e),this.set(n,r)},pull:function(n,e){if(void 0==n||null==n)throw new Error("Key cannot be null");var t=this.get(n);t=_.without(t,e),this.set(n,t)}},loadedItems={},types={Object:Object,Array:Array},Parray=function(n){function e(){_classCallCheck(this,e),_get(Object.getPrototypeOf(e.prototype),"constructor",this).apply(this,arguments)}return _inherits(e,n),e}(Array);registerType(Parray);var Pobject=function n(){_classCallCheck(this,n)};registerType(Pobject),function(){function n(n){return"function"==typeof n}function e(n){return"[object Array]"===Object.prototype.toString.call(n)}function t(n){return n instanceof Date?n.getTime():n instanceof Array?n.map(t):n}function r(n){return function(t,r){if(!e(r))return n(t,r);for(var o=0,i=r.length;i>o;o++)if(n(t,r[o]))return!0;return!1}}function o(n){return function(t,r){if(!e(r))return n(t,r);for(var o=0,i=r.length;i>o;o++)if(!n(t,r[o]))return!1;return!0}}function i(n,e){return n.v(n.a,e)}function c(n,e){for(var t=0;t<n.length;t++)if(i(e,n[t]))return t;return-1}function u(n,e){return{a:n,v:e}}function f(n,e){var t=[];return a(e,n.k,0,t),1===t.length?i(n.nv,t[0]):!!~c(t,n.nv)}function a(n,t,r,o){if(r===t.length||void 0==n)return void o.push(n);if(e(n))for(var i=0,c=n.length;c>i;i++)a(n[i],t,r,o);else a(n[t[r]],t,r+1,o)}function l(n,e){return{a:{k:n,nv:e},v:f}}function s(n){n=t(n),(!n||"Object"!==n.constructor.toString()&&"functionObject(){[nativecode]}"!==n.constructor.toString().replace(/\n/g,"").replace(/ /g,""))&&(n={$eq:n});var e=n.$options,r=[];for(var o in n){var i=n[o];if("$options"!==o)if(h[o])g[o]&&(i="$regex"===o?g[o](i,e):g[o](i)),r.push(u(t(i),h[o]));else{if(36===o.charCodeAt(0))throw new Error("Unknown operation "+o);r.push(l(o.split("."),s(i)))}}return 1===r.length?r[0]:u(r,h.$and)}function d(n,e){var t=s(n);return e&&(t={a:t,v:function(n,t){return i(n,e(t))}}),t}function p(e,t,r){function o(n){return i(c,n)}n(t)&&(r=t,t=void 0);var c=d(e,r);return t?t.filter(o):o}var h={$eq:r(function(n,e){return n(e)}),$ne:o(function(n,e){return!n(e)}),$or:function(n,e){for(var t=0,r=n.length;r>t;t++)if(i(n[t],e))return!0;return!1},$gt:r(function(n,e){return typeof t(e)==typeof n&&t(e)>n}),$gte:r(function(n,e){return typeof t(e)==typeof n&&t(e)>=n}),$lt:r(function(n,e){return typeof t(e)==typeof n&&t(e)<n}),$lte:r(function(n,e){return typeof t(e)==typeof n&&t(e)<=n}),$mod:r(function(n,e){return e%n[0]==n[1]}),$in:function(n,e){if(!(e instanceof Array))return!!~n.indexOf(t(e));for(var r=e.length;r--;)if(~n.indexOf(t(e[r])))return!0;return!1},$nin:function(n,e){return!h.$in(n,e)},$not:function(n,e){return!i(n,e)},$type:function(n,e){return void 0!=e?e instanceof n||e.constructor==n:!1},$all:function(n,e){e||(e=[]);for(var r=n.length;r--;)if(!~t(e).indexOf(n[r]))return!1;return!0},$size:function(n,e){return e?n===e.length:!1},$nor:function(n,e){for(var t=0,r=n.length;r>t;t++)if(i(n[t],e))return!1;return!0},$and:function(n,e){for(var t=0,r=n.length;r>t;t++)if(!i(n[t],e))return!1;return!0},$regex:function(n,e){return"string"==typeof e&&n.test(e)},$where:function(n,e){return n.call(e,e)},$elemMatch:function(n,t){return e(t)?!!~c(t,n):i(n,t)},$exists:function(n,e){return void 0!=e===n}},g={$eq:function(n){return n instanceof RegExp?function(e){return"string"==typeof e&&n.test(e)}:n instanceof Function?n:function(e){return n===t(e)}},$ne:function(n){return g.$eq(n)},$and:function(n){return n.map(s)},$or:function(n){return n.map(s)},$nor:function(n){return n.map(s)},$not:function(n){return s(n)},$regex:function(n,e){return new RegExp(n,e)},$where:function(n){return"string"==typeof n?new Function("obj","return "+n):n},$elemMatch:function(n){return s(n)},$exists:function(n){return!!n}};p.use=function(e){if(n(e))return e(p);for(var t in e)36===t.charCodeAt(0)&&(h[t]=e[t])},p.indexOf=function(n,e,t){return c(e,d(n,t))},"undefined"!=typeof module&&"undefined"!=typeof module.exports?module.exports=p:"undefined"!=typeof window&&(window.sift=p)}();